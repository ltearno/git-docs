<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Git UI</title>
</head>

<body>
    <h1>Status</h1>
    <div id='board-status'></div>

    <div>
        <h1 style="display: inline">Issues</h1>
        <span>
            - add
            <label><input id='new-issue-name' type="text" placeholder="create an issue..." /></label>
            <button id='new-issue-button'>Create issue</button>
        </span>
    </div>
    <ul id='board-issues-ul'>
    </ul>

    <div id='board-opened-issues'></div>

    <script>
        const el = document.getElementById.bind(document)

        function postData(url = '', data = {}) {
            return fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, cors, *same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json',
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrer: 'no-referrer', // no-referrer, *client
                body: JSON.stringify(data), // body data type must match "Content-Type" header
            })
                .then(response => response.json()); // parses JSON response into native JavaScript objects 
        }

        function deleteData(url = '', data = {}) {
            return fetch(url, {
                method: 'DELETE',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrer: 'no-referrer',
                body: JSON.stringify(data)
            })
                .then(response => response.json())
        }

        function clear() {
            el('board-issues-ul').innerHTML = ''
            el('board-opened-issues').innerHTML = ''
        }

        function showIssue(name) {
            if (!name) {
                el('board-opened-issues').innerHTML = ''
                return
            }

            const issueElement = document.createElement('div')
            issueElement.innerHTML += `<h1>Issue ${name}</h1>`
            const metadataElement = document.createElement('div')
            metadataElement.innerHTML += `<h2>Metadata</h2>`
            issueElement.appendChild(metadataElement)
            const contentElement = document.createElement('div')
            contentElement.innerHTML += `<h2>Content</h2>`
            issueElement.appendChild(contentElement)

            el('board-opened-issues').innerHTML = ''
            el('board-opened-issues').appendChild(issueElement)

            fetch(`/api/issues/${name}/metadata`)
                .then(response => response.json())
                .then(metadata => metadataElement.innerHTML += `<pre>${JSON.stringify(metadata, null, 2)}</pre>`)

            fetch(`/api/issues/${name}/content?interpolated=true`)
                .then(response => response.text())
                .then(content => contentElement.innerHTML += `<pre>${content}</pre>`)
        }

        function loadIssues() {
            let prep = ''
            fetch("/api/issues")
                .then(response => response.json())
                .then(issues => {
                    prep += issues.map(name => `<li><button class='delete' onclick='deleteIssue("${name}")'>X</button> <span onclick='showIssue("${name}")'>${name}</span></li>`).join('')
                    el('board-issues-ul').innerHTML = prep
                })
        }

        function loadStatus() {
            fetch("/api/status")
                .then(response => response.json())
                .then(status => {
                    el('board-status').innerHTML = `repository: ${status.gitRepository}<br/>`
                    el('board-status').innerHTML += `<span style='color:${status.clean ? 'green' : 'red'};'>${status.clean ? 'CLEAN' : 'DIRTY'}</span>`
                    if (!status.clean)
                        el('board-status').innerHTML += `<pre>${status.text}</pre>`
                })
        }

        function reloadWithIssue(issue) {
            showIssue(issue)
            loadStatus()
            loadIssues()
        }

        function deleteIssue(name) {
            deleteData(`/api/issues/${name}`)
                .then(_ => {
                    reloadWithIssue(null)
                })
        }

        function addIssue(name) {
            postData(`/api/issues/${name}`, {})
                .then(_ => {
                    reloadWithIssue(name)
                })
        }

        el('new-issue-button').addEventListener('click', () => {
            let name = el('new-issue-name').value

            addIssue(name)
        })

        loadIssues()
        loadStatus()
    </script>
</body>

</html>