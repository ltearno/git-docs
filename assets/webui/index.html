<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="mui-0.9.42/css/mui.css" rel="stylesheet" type="text/css" />
    <!--<link href="mui-0.9.42/extra/mui-rem.css" rel="stylesheet"  type="text/css"/>-->
    <link href="index.css" rel="stylesheet" type="text/css" />
    <script src="mui-0.9.42/js/mui.js"></script>
    <script src="marked.min.js"></script>

    <title>Magic Git UI</title>
</head>

<body class="hide-sidedrawer">
    <div id="sidedrawer" class="mui--no-user-select">
        <div id="sidedrawer-brand" class="mui--appbar-line-height">
            <span class="mui--text-title">Brand.io</span>
        </div>
        <div class="mui-divider"></div>
        <ul>
            <li>
                <strong class="sidedrawer-title">Category 1</strong>
                <ul>
                    <li><a href="#">Item 1</a></li>
                    <li><a href="#">Item 2</a></li>
                    <li><a href="#">Item 3</a></li>
                </ul>
            </li>
            <li>
                <strong class="sidedrawer-title">Category 2</strong>
                <ul>
                    <li><a href="#">Item 1</a></li>
                    <li><a href="#">Item 2</a></li>
                    <li><a href="#">Item 3</a></li>
                </ul>
            </li>
            <li>
                <strong class="sidedrawer-title">Category 3</strong>
                <ul>
                    <li><a href="#">Item 1</a></li>
                    <li><a href="#">Item 2</a></li>
                    <li><a href="#">Item 3</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <header id="header">
        <div class="mui-appbar mui--appbar-line-height">
            <div class="mui-container-fluid">
                <a id="js-show-sidedrawer"
                    class="sidedrawer-toggle mui--visible-xs-inline-block mui--visible-sm-inline-block">☰</a>
                <a id="js-hide-sidedrawer" class="sidedrawer-toggle mui--hidden-xs mui--hidden-sm ">☰</a>
                <span class="mui--text-title mui--visible-xs-inline-block">Brand.io</span>
            </div>
        </div>
    </header>
    <div id="content-wrapper">
        <div class='mui-container-fluid'>
            <div class="mui--appbar-height"></div>
            <h1>Status</h1>
            <div class="mui-panel">
                <div id='board-status'></div>
            </div>

            <h1>Board</h1>
            <div class="mui-panel">
                <div id='tagsList'></div>
                <span>
                    <form id='new-issue-form'>
                        <label>Add issue : <input id='new-issue-name' type="text"
                                placeholder="create an issue..." /></label>
                        <button role="submit" class="mui-btn mui-btn--primary mui-btn--flat">Create issue</button>
                    </form>
                </span>
                <label>Search : <input id='search-issue' type="text" placeholder="search tags..." /></label>
                <br />
                <label>Columns : <input id='columns-issue' type="text"
                        placeholder="list columns sub-search, comma separated" /></label>
                <div id='board-issues-ul'></div>
            </div>

            <h1>Detail zone</h1>
            <div id='board-opened-issues'></div>

            <h1>Logs</h1>
            <div class="mui-panel">
                <div id="log"></div>
            </div>
        </div>
    </div>
    <footer id="footer">
        <div class="mui-container-fluid">
            <br>
            Made with ♥ by <a href="https://github.com/ltearno">Ltearno</a>
        </div>
    </footer>

    <script>
        const badgeColorClass = tag => {
            let c = 0
            for (let i = 0; i < tag.length; i++) {
                c += tag.charCodeAt(i) * 5
            }
            return `badge-color-${c % 4}`
        }

        const memoize = f => {
            const cache = new Map()
            return arg => {
                if (cache.has(arg))
                    return cache.get(arg)
                let value = f(arg)
                cache.set(arg, value)
                return value
            }
        }

        const tagToHtmlBadge = memoize(tag => `<div class="badge ${badgeColorClass(tag)}">${tag}</div>`)

        const el = document.getElementById.bind(document)

        const elFromHtml = html => {
            const e = document.createElement('div')
            e.innerHTML = html
            return e.children.item(0)
        }

        let logMessages = []
        const log = msg => {
            logMessages.push(msg)
            if (logMessages.length > 10)
                logMessages = logMessages.slice(-10)
            el('log').innerHTML = logMessages.map(msg => `<div>${msg}</div>`).join('')
        }

        function postData(url = '', data = {}) {
            return fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, cors, *same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow', // manual, *follow, error
                referrer: 'no-referrer', // no-referrer, *client
                body: JSON.stringify(data), // body data type must match "Content-Type" header
            })
                .then(response => {
                    if (!response.ok) {
                        log(`post to ${url} failed`)
                        return
                    }

                    log(`OK post ${url}`)
                    return response.json()
                })
                .catch(err => log(`post to ${url} failed`))
        }

        function putData(url = '', data = {}) {
            return fetch(url, {
                method: 'PUT',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': typeof data == "string" ? "application/markdown" : 'application/json'
                },
                redirect: 'follow',
                referrer: 'no-referrer',
                body: typeof data == "string" ? data : JSON.stringify(data)
            })
                .then(response => response.json())
                .catch(err => log(`post to ${url} failed`))
        }

        function deleteData(url = '', data = {}) {
            return fetch(url, {
                method: 'DELETE',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrer: 'no-referrer',
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .catch(err => log(`delete to ${url} failed`))
        }

        function clear() {
            el('board-issues-ul').innerHTML = ''
            el('board-opened-issues').innerHTML = ''
        }

        function editIssue(name) {
            el('board-opened-issues').innerHTML = ''

            if (!name)
                return

            const issueElement = document.createElement('div')
            issueElement.classList.add('mui-panel')
            issueElement.innerHTML += `<input id='name-input' type='text' style='font-size:2em;'/></input>`
            const contentElement = document.createElement('div')
            contentElement.innerHTML += `<h2>Content</h2>`
            issueElement.appendChild(contentElement)
            issueElement.appendChild(elFromHtml(`<button onclick='showIssue("${name}")' class="mui-btn mui-btn--raised">Cancel</button>`))
            issueElement.appendChild(elFromHtml(`<button class="validate-edit mui-btn mui-btn--primary mui-btn--raised">Validate</button>`))

            el('board-opened-issues').appendChild(issueElement)

            issueElement.querySelector('#name-input').value = name

            fetch(`/api/issues/${name}/content`)
                .then(response => response.text())
                .then(content => contentElement.innerHTML += `<textarea class='issue-content-textarea' style='width:80em;height:30em;'>${content}</textarea>`)
                .catch(err => log(`get content for ${name} failed`))

            let validateButton = issueElement.getElementsByClassName('validate-edit').item(0)
            validateButton.addEventListener('click', () => {
                let waitCount = 2
                const maybeReload = name => {
                    waitCount--
                    if (!waitCount)
                        reloadWithIssue(name)
                }

                const newName = issueElement.querySelector('#name-input').value
                if (newName != name)
                    postData(`/api/issues/${name}/rename`, { name: newName })
                        .then(_ => {
                            log(`renamed issue ${name}`)
                            maybeReload(newName)
                        })
                        .catch(err => log(`rename ${name} failed`))

                const newContent = issueElement.getElementsByClassName('issue-content-textarea').item(0).value
                if (newContent) {
                    putData(`/api/issues/${name}/content`, newContent)
                        .then(_ => {
                            log(`updated issue ${name} content`)
                            maybeReload(newName)
                        })
                        .catch(err => log(`editIssue ${name} failed`))
                }
                else {
                    log(`no change to content`)
                }
            })
        }

        function addTagToIssue(name, tagToAdd) {
            fetch(`/api/issues/${name}/metadata`)
                .then(response => response.json())
                .then(metadata => {
                    let update = false

                    if (!metadata) {
                        metadata = {}
                        update = true
                    }

                    if (!metadata.tags) {
                        metadata.tags = []
                        update = true
                    }

                    if (!metadata.tags.includes(tagToAdd)) {
                        metadata.tags.push(tagToAdd)
                        update = true
                    }

                    if (update) {
                        // update metadata
                        putData(`/api/issues/${name}/metadata`, metadata)
                            .then(_ => {
                                log(`update issue metadata ${name}`)
                                reloadWithIssue(name)
                            })
                            .catch(err => log(`updateIssue metadata ${name} failed`))
                    }
                    else {
                        log(`tag already present`)
                    }
                })
                .catch(err => log(`get metadata for ${name} failed`))
        }

        function showIssue(name) {
            el('board-opened-issues').innerHTML = ''

            if (!name)
                return

            const issueElement = document.createElement('div')
            issueElement.classList.add('mui-panel')
            issueElement.innerHTML += `<div class='mui--text-dark-secondary mui--text-caption' style='padding-top:1em;padding-bottom:1.7em;'>${name}</div>`
            const metadataElement = document.createElement('div')
            issueElement.appendChild(metadataElement)
            issueElement.appendChild(elFromHtml(`<form id='issue-add-tag-form'>Tags: <label><input id='issue-add-tag-text'/></label><button role='submit' class='mui-btn mui-btn--primary mui-btn--flat'>add tag</button></form>`))
            issueElement.appendChild(elFromHtml('<div class="mui-divider"></div>'))
            const contentElement = document.createElement('div')
            issueElement.appendChild(contentElement)
            issueElement.appendChild(elFromHtml('<div class="mui-divider"></div>'))
            issueElement.appendChild(elFromHtml(`<button onclick='editIssue("${name}")' class="mui-btn mui-btn--primary mui-btn--flat">Edit issue</button>`))

            issueElement.querySelector('#issue-add-tag-form').addEventListener('submit', event => {
                event.preventDefault()
                event.stopPropagation()

                let tag = issueElement.querySelector('#issue-add-tag-text').value

                addTagToIssue(name, tag)
            })

            el('board-opened-issues').appendChild(issueElement)

            fetch(`/api/issues/${name}/metadata`)
                .then(response => response.json())
                .then(metadata => {
                    if (metadata && metadata.tags) {
                        metadataElement.innerHTML += metadata.tags.map(tagToHtmlBadge).join('')
                    }
                    else {
                        metadataElement.innerHTML += `<pre>${JSON.stringify(metadata, null, 2)}</pre>`
                    }
                })
                .catch(err => log(`get metadata for ${name} failed`))

            fetch(`/api/issues/${name}/content?interpolated=true`)
                .then(response => response.text())
                .then(content => {
                    contentElement.innerHTML += marked(content)
                })
                .catch(err => log(`get content for ${name} failed`))
        }

        function loadIssues() {
            let search = el('search-issue').value || null
            let columns = (el('columns-issue').value || '').split(",").map(v => v.trim())
            if (!columns.length)
                columns.push(null)

            let columnsElement = el('board-issues-ul')
            columnsElement.innerHTML = ''

            let issueIndex = -1
            for (let column of columns) {
                issueIndex++

                let q = search ? (column ? `& ${search} ${column}` : search) : column

                let columnElement = document.createElement('div')
                columnElement.classList.add('mui-panel')
                if (issueIndex > 0)
                    columnElement.style.marginLeft = '1em'
                columnsElement.appendChild(columnElement)

                let prep = `<div style='text-align: center;font-weight: bold;padding-bottom: .5em;'>${q || 'All'}</div>`

                fetch(q ? `/api/issues/?q=${encodeURIComponent(q)}` : "/api/issues")
                    .then(response => response.json())
                    .then(issues => {
                        prep += issues.map(name => `<div>- <span onclick='showIssue("${name}")'>${name}</span>&nbsp;<span x-id='tags'></span>&nbsp;&nbsp;&nbsp;<button onclick='deleteIssue("${name}")' class="delete mui-btn mui-btn--small mui-btn--flat mui-btn--danger">X</button></div>`).join('')
                        columnElement.innerHTML = prep

                        let issueToFetchTags = 0
                        const maybeLoad = () => {
                            if (issueToFetchTags >= issues.length)
                                return

                            let loadedIssueTags = issueToFetchTags++
                            let name = issues[loadedIssueTags]

                            fetch(`/api/issues/${name}/metadata`)
                                .then(response => response.json())
                                .then(metadata => {
                                    if (metadata && metadata.tags)
                                        columnElement.children.item(loadedIssueTags + 1).querySelector('[x-id=tags]').innerHTML = metadata.tags.map(tagToHtmlBadge).join('')
                                    maybeLoad()
                                })
                                .catch(err => {
                                    log(`get metadata for ${name} failed`)
                                    maybeLoad()
                                })
                        }

                        maybeLoad()

                    })
                    .catch(err => log(`loadIssues failed`))
            }

            if (!search) {
                fetch("/api/tags")
                    .then(response => response.json())
                    .then(tags => {
                        el('tagsList').innerHTML = "All tags : " + tags.map(tagToHtmlBadge).join('')
                    })
                    .catch(err => log(`loadTags failed`))
            }
        }

        function loadStatus() {
            fetch("/api/status")
                .then(response => response.json())
                .then(status => {
                    el('board-status').innerHTML = `repository: ${status.gitRepository}<br/>`
                    el('board-status').innerHTML += `<span style='color:${status.clean ? 'green' : 'red'};'>${status.clean ? 'ready for operations !' : '.magic-git/... files not synced, commit your changes please'}</span>`
                    if (!status.clean)
                        el('board-status').innerHTML += `<pre>${status.text}</pre>`
                })
                .catch(err => log(`loadStatus failed`))
        }

        function reloadWithIssue(issue) {
            showIssue(issue)
            loadStatus()
            loadIssues()
        }

        function deleteIssue(name) {
            deleteData(`/api/issues/${name}`)
                .then(_ => {
                    log(`delete issue ${name}`)
                    reloadWithIssue(null)
                })
                .catch(err => log(`deleteIssue ${name} failed`))
        }

        function addIssue(name) {
            postData(`/api/issues/${name}`, {})
                .then(_ => {
                    log(`add issue ${name}`)
                    reloadWithIssue(name)
                })
                .catch(err => log(`addIssue ${name} failed`))
        }

        function installUi() {
            let loadIssuesTriggered = false
            const maybeLoadIssues = () => {
                if (loadIssuesTriggered)
                    return

                loadIssuesTriggered = true
                setTimeout(() => {
                    loadIssuesTriggered = false
                    loadIssues()
                }, 50)
            }
            el('search-issue').addEventListener('input', event => {
                maybeLoadIssues()
            })

            el('columns-issue').addEventListener('input', event => {
                maybeLoadIssues()
            })

            el('new-issue-form').addEventListener('submit', event => {
                event.preventDefault()
                event.stopPropagation()

                let name = el('new-issue-name').value
                el('new-issue-name').value = ''

                addIssue(name)
            })

            const $bodyEl = document.body
            const $sidedrawerEl = el('sidedrawer')

            function showSidedrawer() {
                var options = {
                    onclose: function () {
                        $sidedrawerEl
                            .removeClass('active')
                            .appendTo(document.body);
                    }
                };

                var $overlayEl = $(mui.overlay('on', options));

                overlayEl.appendChild($sidedrawerEl)
                setTimeout(function () {
                    $sidedrawerEl.classList.add('active')
                }, 20)
            }


            function hideSidedrawer() {
                $bodyEl.classList.toggle('hide-sidedrawer')
            }

            el('js-show-sidedrawer').addEventListener('click', showSidedrawer)
            el('js-hide-sidedrawer').addEventListener('click', hideSidedrawer)

            titleEls = document.getElementsByClassName('sidedrawer-title')

            for (let i = 0; i < titleEls.length; i++) {
                const titleEl = titleEls.item(i)
                let toToggle = titleEl.nextElementSibling
                toToggle.style.display = "none"
                titleEl.addEventListener('click', () => {
                    toToggle.style.display = toToggle.style.display == "none" ? "" : "none"
                })
            }
        }

        installUi()
        loadIssues()
        loadStatus()
    </script>
</body>

</html>