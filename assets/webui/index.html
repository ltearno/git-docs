<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="mui-0.9.42/css/mui.css" rel="stylesheet" />
    <!--<link href="mui-0.9.42/extra/mui-rem.css" rel="stylesheet" />-->
    <script src="mui-0.9.42/js/mui.js"></script>

    <title>Magic Git UI</title>
</head>

<body>
    <div id="sidedrawer" class="mui--no-user-select">
        <!-- Side drawer content goes here -->
    </div>
    <header id="header">
        <div class="mui-appbar mui--appbar-line-height">
            <div class="mui-container-fluid">
                <a
                    class="sidedrawer-toggle mui--visible-xs-inline-block mui--visible-sm-inline-block js-show-sidedrawer">☰</a>
                <a class="sidedrawer-toggle mui--hidden-xs mui--hidden-sm js-hide-sidedrawer">☰</a>
                <span class="mui--text-title mui--visible-xs-inline-block">Brand.io</span>
            </div>
        </div>
    </header>
    <div id="content-wrapper">
        <h1>Status</h1>
        <div id='board-status'></div>

        <div>
            <h1 style="display: inline">Issues</h1>
            <span>
                <form id='new-issue-form'>
                    - add
                    <label><input id='new-issue-name' type="text" placeholder="create an issue..." /></label>
                    <button role="submit">Create issue</button>
                </form>
            </span>
        </div>
        <ul id='board-issues-ul'>
        </ul>

        <div id='board-opened-issues'></div>

        <div id="log"></div>
    </div>
    <footer id="footer">
        <div class="mui-container-fluid">
            <br>
            Made with ♥ by <a href="https://github.com/ltearno">Ltearno</a>
        </div>
    </footer>

    <script>
        const el = document.getElementById.bind(document)

        const elFromHtml = html => {
            const e = document.createElement('div')
            e.innerHTML = html
            return e.children.item(0)
        }

        let logMessages = []
        const log = msg => {
            logMessages.push(msg)
            if (logMessages.length > 10)
                logMessages = logMessages.slice(0, 10)
            el('log').innerHTML = logMessages.map(msg => `<div>${msg}</div>`).join('')
        }

        function postData(url = '', data = {}) {
            return fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, cors, *same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json',
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrer: 'no-referrer', // no-referrer, *client
                body: JSON.stringify(data), // body data type must match "Content-Type" header
            })
                .then(response => response.json())
                .catch(err => log(`post to ${url} failed`))
        }

        function deleteData(url = '', data = {}) {
            return fetch(url, {
                method: 'DELETE',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrer: 'no-referrer',
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .catch(err => log(`delete to ${url} failed`))
        }

        function clear() {
            el('board-issues-ul').innerHTML = ''
            el('board-opened-issues').innerHTML = ''
        }

        function editIssue(name) {
            el('board-opened-issues').innerHTML = ''

            if (!name)
                return

            const issueElement = document.createElement('div')
            issueElement.innerHTML += `<h1>Issue ${name}</h1>`
            const contentElement = document.createElement('div')
            contentElement.innerHTML += `<h2>Content</h2>`
            issueElement.appendChild(contentElement)
            issueElement.appendChild(elFromHtml(`<button onclick='showIssue("${name}")'>Cancel</button>`))

            el('board-opened-issues').appendChild(issueElement)

            fetch(`/api/issues/${name}/content`)
                .then(response => response.text())
                .then(content => contentElement.innerHTML += `<textarea style='width:80em;height:30em;'>${content}</textarea>`)
                .catch(err => log(`get content for ${name} failed`))
        }

        function showIssue(name) {
            el('board-opened-issues').innerHTML = ''

            if (!name)
                return

            const issueElement = document.createElement('div')
            issueElement.innerHTML += `<h1>Issue ${name}</h1>`
            const metadataElement = document.createElement('div')
            metadataElement.innerHTML += `<h2>Metadata</h2>`
            issueElement.appendChild(metadataElement)
            const contentElement = document.createElement('div')
            contentElement.innerHTML += `<h2>Content</h2>`
            issueElement.appendChild(contentElement)
            issueElement.appendChild(elFromHtml(`<button onclick='editIssue("${name}")'>Edit issue</button>`))

            el('board-opened-issues').appendChild(issueElement)

            fetch(`/api/issues/${name}/metadata`)
                .then(response => response.json())
                .then(metadata => metadataElement.innerHTML += `<pre>${JSON.stringify(metadata, null, 2)}</pre>`)
                .catch(err => log(`get metadata for ${name} failed`))

            fetch(`/api/issues/${name}/content?interpolated=true`)
                .then(response => response.text())
                .then(content => contentElement.innerHTML += `<pre>${content}</pre>`)
                .catch(err => log(`get content for ${name} failed`))
        }

        function loadIssues() {
            let prep = ''
            fetch("/api/issues")
                .then(response => response.json())
                .then(issues => {
                    prep += issues.map(name => `<li><button class='delete' onclick='deleteIssue("${name}")'>X</button> <span onclick='showIssue("${name}")'>${name}</span></li>`).join('')
                    el('board-issues-ul').innerHTML = prep
                })
                .catch(err => log(`loadIssues failed`))
        }

        function loadStatus() {
            fetch("/api/status")
                .then(response => response.json())
                .then(status => {
                    el('board-status').innerHTML = `repository: ${status.gitRepository}<br/>`
                    el('board-status').innerHTML += `<span style='color:${status.clean ? 'green' : 'red'};'>${status.clean ? 'ready for operations !' : '.magic-git/... files not synced, commit your changes please'}</span>`
                    //if (!status.clean)
                    el('board-status').innerHTML += `<pre>${status.text}</pre>`
                })
                .catch(err => log(`loadStatus failed`))
        }

        function reloadWithIssue(issue) {
            showIssue(issue)
            loadStatus()
            loadIssues()
        }

        function deleteIssue(name) {
            deleteData(`/api/issues/${name}`)
                .then(_ => {
                    reloadWithIssue(null)
                })
                .catch(err => log(`deleteIssue ${name} failed`))
        }

        function addIssue(name) {
            postData(`/api/issues/${name}`, {})
                .then(_ => {
                    reloadWithIssue(name)
                })
                .catch(err => log(`addIssue ${name} failed`))
        }

        el('new-issue-form').addEventListener('submit', event => {
            event.preventDefault()
            event.stopPropagation()

            let name = el('new-issue-name').value
            el('new-issue-name').value = ''

            addIssue(name)
        })

        loadIssues()
        loadStatus()
    </script>
</body>

</html>